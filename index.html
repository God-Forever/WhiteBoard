<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <title>智能白板</title>
    <style>
        :root {
            --bg: #f0f4f8;
            --panel-bg: #ffffff;
            --accent: #0891b2;
            --accent-hover: #0e7490;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --disabled: #cbd5e1;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans SC', sans-serif;
        }
        
        body {
            overflow: hidden;
            touch-action: none;
            background: var(--bg);
        }
        
        .canvas-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        .whiteboard-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }
        
        .toolbar {
            position: fixed;
            left: 50%;
            bottom: 24px;
            transform: translateX(-50%);
            background: var(--panel-bg);
            border-radius: 16px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            z-index: 100;
            border: 1px solid var(--border);
            pointer-events: none;
        }
        
        .toolbar * {
            pointer-events: auto;
        }
        
        .tool-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s ease, transform 0.1s ease;
            color: var(--text-muted);
        }
        
        .tool-btn:hover:not(:disabled) {
            background: var(--bg);
            color: var(--text);
        }
        
        .tool-btn:active:not(:disabled) {
            transform: scale(0.95);
        }
        
        .tool-btn.active {
            background: var(--accent);
            color: white;
        }
        
        .tool-btn.active:hover {
            background: var(--accent-hover);
            color: white;
        }
        
        .tool-btn:disabled {
            color: var(--disabled);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .tool-btn svg {
            width: 22px;
            height: 22px;
        }
        
        /* 新增：退出按钮样式 */
        .tool-btn.danger:hover:not(:disabled) {
            background: #fee2e2;
            color: #dc2626;
        }

        .divider {
            width: 1px;
            height: 32px;
            background: var(--border);
            margin: 0 8px;
        }
        
        .page-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--panel-bg);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            box-shadow: var(--shadow);
            z-index: 100;
            pointer-events: none;
        }
        
        .page-dots {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }
        
        .page-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .page-dot:hover {
            transform: scale(1.2);
        }
        
        .page-dot.active {
            background: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(8, 145, 178, 0.2);
        }
        
        .page-dot.active:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }
        
        .popup-panel {
            position: fixed;
            background: var(--panel-bg);
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--shadow);
            z-index: 150;
            border: 1px solid var(--border);
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            width: 220px;
        }
        
        .popup-panel.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        
        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .setting-label {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .brush-size-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: linear-gradient(to right, var(--accent), var(--accent));
            border-radius: 3px;
            outline: none;
        }
        
        .brush-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--accent);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        .color-palette {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
        }
        
        .color-btn {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.15s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .color-btn:hover {
            transform: scale(1.15);
            z-index: 1;
        }
        
        .color-btn.active {
            border-color: var(--text);
            box-shadow: 0 0 0 2px white, 0 0 0 4px var(--text);
        }
        
        .color-btn.active:hover {
            transform: scale(1.1);
            border-color: var(--text);
            box-shadow: 0 0 0 2px white, 0 0 0 4px var(--text);
        }
        
        .color-label {
            position: absolute;
            font-size: 7px;
            font-weight: 700;
            color: inherit;
            text-shadow: 0 0 2px rgba(255,255,255,0.5);
            pointer-events: none;
        }
        
        .bg-color-palette {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        
        .bg-color-btn {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .bg-color-btn:hover {
            transform: scale(1.15);
        }
        
        .bg-color-btn.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(8, 145, 178, 0.3);
        }
        
        .bg-color-btn.active:hover {
            transform: scale(1.1);
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(8, 145, 178, 0.5);
        }
        
        .size-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
        }
        
        .size-dot {
            border-radius: 50%;
            background: var(--text);
            transition: all 0.2s ease;
        }
        
        .settings-panel {
            position: fixed;
            background: var(--panel-bg);
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--shadow);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 16px;
            border: 1px solid var(--border);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        
        .settings-panel.visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        @media (prefers-reduced-motion: reduce) {
            * {
                transition: none !important;
                animation: none !important;
            }
        }
        
        @media (max-width: 768px) {
            .toolbar {
                bottom: 16px;
                padding: 10px 14px;
                gap: 4px;
            }
            
            .tool-btn {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="canvas-container" id="canvasContainer"></div>
    
    <div class="page-indicator" id="pageIndicator">第 1 页</div>
    
    <div class="page-dots" id="pageDots"></div>
    
    <!-- 画笔设置面板 -->
    <div class="popup-panel" id="penPanel">
        <div class="setting-group" style="margin-bottom: 12px;">
            <div class="setting-label">笔刷粗细</div>
            <input type="range" class="brush-size-slider" id="brushSize" min="1" max="30" value="3">
            <div class="size-preview">
                <div class="size-dot" id="sizeDot"></div>
            </div>
        </div>
        <div class="setting-group">
            <div class="setting-label">笔刷颜色</div>
            <div class="color-palette" id="colorPalette"></div>
        </div>
    </div>
    
    <!-- 橡皮设置面板 -->
    <div class="popup-panel" id="eraserPanel">
        <div class="setting-group">
            <div class="setting-label">橡皮粗细</div>
            <input type="range" class="brush-size-slider" id="eraserSize" min="10" max="100" value="40">
            <div class="size-preview">
                <div class="size-dot" id="eraserSizeDot"></div>
            </div>
        </div>
    </div>
    
    <!-- 设置面板（页面颜色） -->
    <div class="settings-panel" id="settingsPanel">
        <div class="setting-group">
            <div class="setting-label">页面颜色</div>
            <div class="bg-color-palette" id="bgColorPalette"></div>
        </div>
    </div>
    
    <div class="toolbar">
        <button class="tool-btn active" id="penTool" title="画笔（再次点击设置）">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                <path d="M2 2l7.586 7.586"/>
                <circle cx="11" cy="11" r="2"/>
            </svg>
        </button>
        
        <button class="tool-btn" id="eraserTool" title="橡皮（再次点击设置）">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 20H7L3 16c-.8-.8-.8-2 0-2.8l10-10c.8-.8 2-.8 2.8 0l6 6c.8.8.8 2 0 2.8L14 20"/>
                <path d="M7 20l7-7"/>
            </svg>
        </button>
        
        <button class="tool-btn" id="moveTool" title="移动">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="5 9 2 12 5 15"/>
                <polyline points="9 5 12 2 15 5"/>
                <polyline points="15 19 12 22 9 19"/>
                <polyline points="19 9 22 12 19 15"/>
                <line x1="2" y1="12" x2="22" y2="12"/>
                <line x1="12" y1="2" x2="12" y2="22"/>
            </svg>
        </button>
        
        <div class="divider"></div>
        
        <button class="tool-btn" id="undoBtn" title="撤销 (Ctrl+Z)" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 7v6h6"/>
                <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/>
            </svg>
        </button>
        
        <button class="tool-btn" id="redoBtn" title="重做 (Ctrl+Shift+Z)" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 7v6h-6"/>
                <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"/>
            </svg>
        </button>
        
        <button class="tool-btn" id="clearBtn" title="清空当前页">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
        </button>
        
        <div class="divider"></div>
        
        <button class="tool-btn" id="addPageBtn" title="添加页面">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="12" y1="18" x2="12" y2="12"/>
                <line x1="9" y1="15" x2="15" y2="15"/>
            </svg>
        </button>
        
        <button class="tool-btn" id="deletePageBtn" title="点击删除页面">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="9" y1="15" x2="15" y2="15"/>
            </svg>
        </button>
        
        <div class="divider"></div>
        
        <button class="tool-btn" id="settingsBtn" title="页面设置">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <path d="M3 9h18" stroke-dasharray="2 2"/>
                <circle cx="7.5" cy="6.5" r="0.5" fill="currentColor"/>
                <circle cx="10.5" cy="6.5" r="0.5" fill="currentColor"/>
            </svg>
        </button>

        <!-- 退出按钮 -->
        <button class="tool-btn danger" id="exitBtn" title="隐藏白板">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>
    
    <script>
        // ==================== 新增：Qt通信桥梁 (修复版) ====================
        var external = null;
        
        // 等待页面完全加载后初始化 Channel
        window.onload = function() {
            // 确保 QWebChannel 存在 (Qt环境)
            if (typeof QWebChannel === 'function') {
                // 检查 qt 对象是否存在
                if (typeof qt !== 'undefined' && qt.webChannelTransport) {
                    new QWebChannel(qt.webChannelTransport, function(channel) {
                        external = channel.objects.external;
                        console.log("✅ Qt WebChannel 已连接, external对象获取成功");
                    });
                } else {
                    console.warn("❌ qt.webChannelTransport 不存在，可能是独立浏览器环境");
                }
            } else {
                console.warn("❌ QWebChannel 未定义");
            }

            // 初始化页面
            initColorPalette();
            initBgColorPalette();
            updateBrushSize();
            updateEraserSize();
            initFirstPage();
        };

        // 关闭窗口的函数
        function closeWhiteboard() {
            console.log("尝试调用 closeWhiteboard...");
            if (external) {
                console.log("正在调用 external.hideWindow()...");
                external.hideWindow();
            } else {
                console.error("❌ external 对象不存在，无法调用 Python 函数");
            }
        }

        // 颜色定义
        const colors = [
            'invert', '#dc2626', '#ea580c', '#ca8a04', '#16a34a',
            '#0891b2', '#2563eb', '#7c3aed', '#db2777', 'same'
        ];
        
        const bgColors = [
            '#ffffff', '#fef3c7', '#dcfce7', '#e0f2fe',
            '#f3e8ff', '#fce7f3', '#f1f5f9', '#1e293b',
            '#0f172a', '#1e1e1e', '#2d1f3d', '#1a2f4a'
        ];
        
        // 状态变量
        let pages = [];
        let currentPageIndex = 0;
        let currentTool = 'pen';
        let currentColor = 'invert';
        let currentBgColor = '#ffffff';
        let brushSize = 3;
        let eraserSize = 40;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let settingsVisible = false;
        let penPanelVisible = false;
        let eraserPanelVisible = false;
        
        // 移动相关
        let isMoving = false;
        let moveStartX = 0;
        let moveStartY = 0;
        
        // 当前绘制的动作组缓存
        let currentActionGroup = [];
        
        // DOM 元素引用
        const canvasContainer = document.getElementById('canvasContainer');
        const pageIndicator = document.getElementById('pageIndicator');
        const pageDotsContainer = document.getElementById('pageDots');
        const settingsPanel = document.getElementById('settingsPanel');
        const penPanel = document.getElementById('penPanel');
        const eraserPanel = document.getElementById('eraserPanel');
        const brushSizeSlider = document.getElementById('brushSize');
        const eraserSizeSlider = document.getElementById('eraserSize');
        const sizeDot = document.getElementById('sizeDot');
        const eraserSizeDot = document.getElementById('eraserSizeDot');
        const colorPalette = document.getElementById('colorPalette');
        const bgColorPalette = document.getElementById('bgColorPalette');
        
        // 工具按钮
        const penTool = document.getElementById('penTool');
        const eraserTool = document.getElementById('eraserTool');
        const moveTool = document.getElementById('moveTool');
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        const clearBtn = document.getElementById('clearBtn');
        const addPageBtn = document.getElementById('addPageBtn');
        const deletePageBtn = document.getElementById('deletePageBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const exitBtn = document.getElementById('exitBtn'); // 退出按钮引用
        
        // 核心功能：根据背景色计算实际显示颜色
        function getActualColor(colorMode, bgColor) {
            if (colorMode === 'invert') {
                return isLightColor(bgColor) ? '#1e293b' : '#ffffff';
            } else if (colorMode === 'same') {
                return isLightColor(bgColor) ? '#ffffff' : '#1e293b';
            }
            return colorMode;
        }
        
        // 判断颜色是否为浅色
        function isLightColor(hexColor) {
            const r = parseInt(hexColor.slice(1, 3), 16);
            const g = parseInt(hexColor.slice(3, 5), 16);
            const b = parseInt(hexColor.slice(5, 7), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness >= 128;
        }
        
        // 创建页面 - 4倍视窗大小，性能与空间的最佳平衡
        function createPage() {
            const canvas = document.createElement('canvas');
            canvas.className = 'whiteboard-canvas';
            
            const w = window.innerWidth * 4;
            const h = window.innerHeight * 4;
            
            canvas.width = w;
            canvas.height = h;
            canvas.style.width = w + 'px';
            canvas.style.height = h + 'px';
            canvas.style.backgroundColor = currentBgColor;
            
            const initialViewX = -w / 2 + window.innerWidth / 2;
            const initialViewY = -h / 2 + window.innerHeight / 2;
            canvas.style.transform = `translate(${initialViewX}px, ${initialViewY}px)`;
            
            const ctx = canvas.getContext('2d');
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            const page = {
                canvas: canvas,
                ctx: ctx,
                snapshotStack: [[]],
                snapshotIndex: 0,
                bgColor: currentBgColor,
                viewX: initialViewX,
                viewY: initialViewY
            };
            
            return page;
        }
        
        // 核心渲染函数：根据快照索引重绘页面
        function renderPage(page, index) {
            if (index < 0 || index >= page.snapshotStack.length) return;
            
            const ctx = page.ctx;
            ctx.clearRect(0, 0, page.canvas.width, page.canvas.height);
            
            const actions = page.snapshotStack[index];
            
            actions.forEach(group => {
                if (group.length === 0) return;
                
                const firstAction = group[0];
                ctx.globalCompositeOperation = 'source-over';
                ctx.lineWidth = firstAction.size;
                
                if (firstAction.tool === 'eraser') {
                    ctx.strokeStyle = page.bgColor;
                } else {
                    ctx.strokeStyle = getActualColor(firstAction.color, page.bgColor);
                }
                
                ctx.beginPath();
                ctx.moveTo(group[0].x1, group[0].y1);
                
                group.forEach(action => {
                    ctx.lineTo(action.x2, action.y2);
                });
                
                ctx.stroke();
            });
        }
        
        // 初始化第一个页面
        function initFirstPage() {
            const page = createPage();
            pages.push(page);
            canvasContainer.appendChild(page.canvas);
            updatePageIndicator();
            updatePageDots();
            updateUndoRedoButtons();
            updateDynamicColorPreviews();
        }
        
        // 切换页面
        function switchPage(index) {
            if (index < 0 || index >= pages.length) return;
            
            pages[currentPageIndex].canvas.style.display = 'none';
            currentPageIndex = index;
            pages[currentPageIndex].canvas.style.display = 'block';
            currentBgColor = pages[currentPageIndex].bgColor;
            
            updatePageIndicator();
            updatePageDots();
            updateBgColorSelection();
            updateUndoRedoButtons();
            updateDynamicColorPreviews();
        }
        
        // 添加新页面
        function addPage() {
            const page = createPage();
            pages.push(page);
            
            pages.forEach(p => p.canvas.style.display = 'none');
            canvasContainer.appendChild(page.canvas);
            currentPageIndex = pages.length - 1;
            
            page.canvas.style.display = 'block';
            
            updatePageIndicator();
            updatePageDots();
            updateUndoRedoButtons();
        }
        
        // 删除当前页面
        function deletePage() {
            if (pages.length <= 1) return;
            
            canvasContainer.removeChild(pages[currentPageIndex].canvas);
            pages.splice(currentPageIndex, 1);
            
            if (currentPageIndex >= pages.length) {
                currentPageIndex = pages.length - 1;
            }
            
            pages[currentPageIndex].canvas.style.display = 'block';
            updatePageIndicator();
            updatePageDots();
            updateUndoRedoButtons();
        }
        
        // 更新页面指示器
        function updatePageIndicator() {
            pageIndicator.textContent = `第 ${currentPageIndex + 1} 页`;
        }
        
        // 更新页面点
        function updatePageDots() {
            pageDotsContainer.innerHTML = '';
            pages.forEach((_, index) => {
                const dot = document.createElement('div');
                dot.className = `page-dot ${index === currentPageIndex ? 'active' : ''}`;
                dot.addEventListener('click', () => switchPage(index));
                pageDotsContainer.appendChild(dot);
            });
        }
        
        // 更新撤销重做按钮状态
        function updateUndoRedoButtons() {
            const page = pages[currentPageIndex];
            if (!page) return;
            
            undoBtn.disabled = page.snapshotIndex <= 0;
            redoBtn.disabled = page.snapshotIndex >= page.snapshotStack.length - 1;
        }
        
        // 清空画布
        function clearCanvas() {
            const page = pages[currentPageIndex];
            if (page.snapshotStack[page.snapshotIndex].length > 0) {
                page.snapshotStack = page.snapshotStack.slice(0, page.snapshotIndex + 1);
                page.snapshotStack.push([]);
                page.snapshotIndex++;
                
                renderPage(page, page.snapshotIndex);
                updateUndoRedoButtons();
            }
        }
        
        // 获取画布坐标
        function getCanvasCoords(e, page) {
            const rect = page.canvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }
        
        // 绘图处理
        function handlePointerDown(e) {
            const page = pages[currentPageIndex];
            if (!page) return;

            if (e.target.closest('.toolbar, .popup-panel, .settings-panel, .page-dot')) {
                return;
            }
            
            if (currentTool === 'move') {
                isMoving = true;
                moveStartX = e.clientX - page.viewX;
                moveStartY = e.clientY - page.viewY;
                page.canvas.style.cursor = 'grabbing';
                return;
            }
            
            isDrawing = true;
            const coords = getCanvasCoords(e, page);
            lastX = coords.x;
            lastY = coords.y;
            
            currentActionGroup = [];
        }
        
        function handlePointerMove(e) {
            const page = pages[currentPageIndex];
            if (!page) return;
            
            if (isMoving) {
                const newViewX = e.clientX - moveStartX;
                const newViewY = e.clientY - moveStartY;
                
                page.viewX = newViewX;
                page.viewY = newViewY;
                page.canvas.style.transform = `translate(${newViewX}px, ${newViewY}px)`;
                return;
            }
            
            if (!isDrawing) return;
            
            const coords = getCanvasCoords(e, page);
            const x = coords.x;
            const y = coords.y;
            
            const action = {
                tool: currentTool,
                color: currentColor,
                size: currentTool === 'pen' ? brushSize : eraserSize,
                x1: lastX,
                y1: lastY,
                x2: x,
                y2: y
            };
            
            currentActionGroup.push(action);
            
            const ctx = page.ctx;
            ctx.globalCompositeOperation = 'source-over';
            
            if (currentTool === 'eraser') {
                ctx.strokeStyle = page.bgColor;
                ctx.lineWidth = eraserSize;
            } else {
                ctx.strokeStyle = getActualColor(currentColor, page.bgColor);
                ctx.lineWidth = brushSize;
            }
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            lastX = x;
            lastY = y;
        }
        
        function handlePointerUp(e) {
            const page = pages[currentPageIndex];
            if (!page) return;
            
            if (isMoving) {
                isMoving = false;
                page.canvas.style.cursor = 'grab';
                return;
            }
            
            if (isDrawing && currentActionGroup.length > 0) {
                page.snapshotStack = page.snapshotStack.slice(0, page.snapshotIndex + 1);
                const newSnapshot = [...page.snapshotStack[page.snapshotIndex], currentActionGroup];
                page.snapshotStack.push(newSnapshot);
                page.snapshotIndex++;
                
                updateUndoRedoButtons();
            }
            
            isDrawing = false;
            currentActionGroup = [];
        }
        
        // 工具切换
        function setTool(tool, fromClick = false) {
            if (fromClick && currentTool === tool) {
                if (tool === 'pen') {
                    togglePenPanel();
                } else if (tool === 'eraser') {
                    toggleEraserPanel();
                }
                return;
            }
            
            currentTool = tool;
            [penTool, eraserTool, moveTool].forEach(btn => btn.classList.remove('active'));
            
            closeAllPanels();
            
            const page = pages[currentPageIndex];
            if (tool === 'pen') {
                penTool.classList.add('active');
                if (page) page.canvas.style.cursor = 'crosshair';
            } else if (tool === 'eraser') {
                eraserTool.classList.add('active');
                if (page) page.canvas.style.cursor = 'cell';
            } else if (tool === 'move') {
                moveTool.classList.add('active');
                if (page) page.canvas.style.cursor = 'grab';
            }
        }
        
        // 撤销
        function undo() {
            const page = pages[currentPageIndex];
            if (page.snapshotIndex > 0) {
                page.snapshotIndex--;
                renderPage(page, page.snapshotIndex);
                updateUndoRedoButtons();
            }
        }
        
        // 重做
        function redo() {
            const page = pages[currentPageIndex];
            if (page.snapshotIndex < page.snapshotStack.length - 1) {
                page.snapshotIndex++;
                renderPage(page, page.snapshotIndex);
                updateUndoRedoButtons();
            }
        }
        
        // 关闭所有弹出面板
        function closeAllPanels() {
            penPanelVisible = false;
            eraserPanelVisible = false;
            settingsVisible = false;
            penPanel.classList.remove('visible');
            eraserPanel.classList.remove('visible');
            settingsPanel.classList.remove('visible');
        }
        
        // 切换画笔面板
        function togglePenPanel() {
            penPanelVisible = !penPanelVisible;
            if (penPanelVisible) {
                closeAllPanels();
                penPanelVisible = true;
                positionPanel(penPanel, penTool);
                penPanel.classList.add('visible');
            } else {
                penPanel.classList.remove('visible');
            }
        }
        
        // 切换橡皮面板
        function toggleEraserPanel() {
            eraserPanelVisible = !eraserPanelVisible;
            if (eraserPanelVisible) {
                closeAllPanels();
                eraserPanelVisible = true;
                positionPanel(eraserPanel, eraserTool);
                eraserPanel.classList.add('visible');
            } else {
                eraserPanel.classList.remove('visible');
            }
        }
        
        // 定位弹出面板
        function positionPanel(panel, anchorBtn) {
            const btnRect = anchorBtn.getBoundingClientRect();
            const panelRect = { width: 220, height: panel.offsetHeight || 200 };
            
            let left = btnRect.left + btnRect.width / 2 - panelRect.width / 2;
            let top = btnRect.top - panelRect.height - 15;
            
            if (left < 10) left = 10;
            if (left + panelRect.width > window.innerWidth - 10) left = window.innerWidth - panelRect.width - 10;
            if (top < 10) top = btnRect.bottom + 10;
            
            panel.style.left = `${left}px`;
            panel.style.top = `${top}px`;
        }
        
        // 更新动态颜色按钮的预览
        function updateDynamicColorPreviews() {
            const invertBtn = document.querySelector('.color-btn[data-color="invert"]');
            if (invertBtn) {
                const displayColor = getActualColor('invert', currentBgColor);
                invertBtn.style.backgroundColor = displayColor;
                invertBtn.style.color = displayColor === '#1e293b' ? '#1e293b' : '#ffffff';
            }
            
            const sameBtn = document.querySelector('.color-btn[data-color="same"]');
            if (sameBtn) {
                const displayColor = getActualColor('same', currentBgColor);
                sameBtn.style.backgroundColor = displayColor;
                sameBtn.style.color = displayColor === '#1e293b' ? '#1e293b' : '#ffffff';
            }
        }
        
        // 初始化颜色面板
        function initColorPalette() {
            colorPalette.innerHTML = '';
            colors.forEach((color, index) => {
                const btn = document.createElement('button');
                btn.className = `color-btn ${index === 0 ? 'active' : ''}`;
                btn.dataset.color = color;
                
                if (color === 'invert') {
                    btn.style.backgroundColor = '#1e293b';
                } else if (color === 'same') {
                    btn.style.backgroundColor = '#ffffff';
                    btn.style.border = '2px solid #e2e8f0';
                } else {
                    btn.style.backgroundColor = color;
                }
                
                if (color === '#ffffff' || color === 'same') {
                    btn.style.border = '2px solid #e2e8f0';
                }
                
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentColor = color;
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
                colorPalette.appendChild(btn);
            });
        }
        
        // 初始化背景颜色面板
        function initBgColorPalette() {
            bgColorPalette.innerHTML = '';
            bgColors.forEach((color, index) => {
                const btn = document.createElement('button');
                btn.className = `bg-color-btn ${index === 0 ? 'active' : ''}`;
                btn.style.backgroundColor = color;
                if (color === '#0f172a' || color === '#1e1e1e' || color === '#2d1f3d' || color === '#1a2f4a') {
                    btn.style.border = '2px solid #475569';
                }
                btn.addEventListener('click', () => {
                    currentBgColor = color;
                    pages[currentPageIndex].bgColor = color;
                    pages[currentPageIndex].canvas.style.backgroundColor = color;
                    
                    renderPage(pages[currentPageIndex], pages[currentPageIndex].snapshotIndex);
                    updateDynamicColorPreviews();
                    updateBgColorSelection();
                    
                    const actualColor = getActualColor(currentColor, color);
                    sizeDot.style.background = actualColor;
                });
                bgColorPalette.appendChild(btn);
            });
        }
        
        function updateBgColorSelection() {
            document.querySelectorAll('.bg-color-btn').forEach((btn, index) => {
                btn.classList.toggle('active', bgColors[index] === currentBgColor);
            });
        }
        
        // 更新笔刷大小预览
        function updateBrushSize() {
            brushSize = parseInt(brushSizeSlider.value);
            const size = Math.max(4, brushSize);
            sizeDot.style.width = `${size}px`;
            sizeDot.style.height = `${size}px`;
        }
        
        // 更新橡皮大小预览
        function updateEraserSize() {
            eraserSize = parseInt(eraserSizeSlider.value);
            eraserSizeDot.style.width = `${eraserSize}px`;
            eraserSizeDot.style.height = `${eraserSize}px`;
        }
        
        // 点击空白处关闭面板
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.popup-panel') && 
                !e.target.closest('.tool-btn') &&
                !e.target.closest('.settings-panel')) {
                closeAllPanels();
            }
        });
        
        // 事件绑定
        document.addEventListener('pointerdown', handlePointerDown);
        document.addEventListener('pointermove', handlePointerMove);
        document.addEventListener('pointerup', handlePointerUp);
        document.addEventListener('pointerleave', handlePointerUp);
        
        // 工具按钮事件
        penTool.addEventListener('click', () => setTool('pen', true));
        eraserTool.addEventListener('click', () => setTool('eraser', true));
        moveTool.addEventListener('click', () => setTool('move', true));
        undoBtn.addEventListener('click', undo);
        redoBtn.addEventListener('click', redo);
        clearBtn.addEventListener('click', clearCanvas);
        addPageBtn.addEventListener('click', addPage);
        deletePageBtn.addEventListener('click', deletePage);
        
        settingsBtn.addEventListener('click', () => {
             settingsVisible = !settingsVisible;
             if (settingsVisible) {
                closeAllPanels();
                settingsVisible = true;
                settingsPanel.classList.add('visible'); 
                positionPanel(settingsPanel, settingsBtn);
             } else {
                settingsPanel.classList.remove('visible');
             }
        });

        // 退出按钮事件绑定
        exitBtn.addEventListener('click', closeWhiteboard);
        
        brushSizeSlider.addEventListener('input', updateBrushSize);
        eraserSizeSlider.addEventListener('input', updateEraserSize);
        
        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'z') {
                    e.preventDefault();
                    if (e.shiftKey) {
                        redo();
                    } else {
                        undo();
                    }
                }
            }
        });
    </script>
</body>
</html>
